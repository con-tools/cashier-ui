<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<dom-module id="controll-event-search">
<template>
	<style>
	.hidden { 
		display: none;
	}
	strong {
		padding: 0 2em;
	}
	.roundText {
		width: 6.5em;
	}
	.startText {
		width: 9.5em;
	}
	.seats {
		width: 1.2em;
		display: inline-block;
		padding-right: .2em;
	}
	.price {
		width: 3em;
	}
	.table-field {
		padding-right: 1em;
	}
	</style>
	<style is="custom-style" include="iron-flex iron-flex-alignment"></style>
	<style is="custom-style" include="shared-styles"></style>
	
	<paper-material lang="he">
		<h1 class="page-title" tabindex="-1">חיפוש ארועים</h1>
		<paper-item>
			<paper-input disabled="disabled" name="name" label="שם" on-keyup="doSearch" id="searchName">
		</paper-item>
	</paper-material>
	
	<paper-toast id="addedToCart" text="Added {{timeslotTitle}} to cart"></paper-toast>
	
	<paper-material lang="he">
		<template is="dom-repeat" items="[[filteredTimeslots]]" as="timeslot">
			<paper-item class="layout horizontal">
				<paper-icon-button icon="exit-to-app" on-tap="showEvent"></paper-icon-button>
				<paper-icon-button icon="shopping-cart" on-tap="addToCart"></paper-icon-button>
				<div class="flex">[[timeslot.event.title]]</div>
				<div class="table-field"><iron-icon icon="event-seat"></iron-icon><span class="seats">[[timeslot.available_tickets]]</span>/<span class="seats">[[timeslot.max_attendees]]</span></div>
				<div class="price table-field">&#8362;[[timeslot.event.price]]</div>
				<div class="roundText table-field"><iron-icon icon="history"></iron-icon><span>[[timeslot.round]]</span></div>
				<strong>התחלה:</strong>
				<div class="startText">[[timeslot.displayTime]]</div>
			</paper-item>
		</template>
	</paper-material>
</template>
</dom-module>

<script>
Polymer({
	is : 'controll-event-search',
	properties : {
		timeslots : {
			type: Array,
			value: function() { return []; }
		},
		filteredTimeslots : {
			type: Array,
			value: function() { return []; }
		},
		timeslotTitle : String,
	},
	
	ready : function(event) {
		this.set('timeslots',[]);
		this.$.searchName.value = 'נא להמתין בזמן שמידע נטען...';
		app.getCatalog('timeslots',this.populateTimeslots.bind(this));
	},
	
	attached : function(event) {
		app.addEventListener('please-refresh-lists', this.ready.bind(this), false);
	},
	
	populateTimeslots : function(timeslots) {
		this.set('timeslots',timeslots.map(function(timeslot){
			timeslot.displayTime = moment(timeslot.start).format("MMM D, YYYY HH:mm");
			timeslot.round = app.getRound(timeslot.start);
			timeslot.event.price = parseInt(timeslot.event.price);
			return app.dejsonify(timeslot);
		}).sort(function(a,b){
			return moment(a.start).valueOf() - moment(b.start).valueOf();
		}));
		this.$.searchName.value = null;
		this.filterBySearch();
		this.$.searchName.disabled = false;
	},
	
	doSearch : function() {
		this.filterBySearch(this.$.searchName.value);
	},
	
	filterBySearch : function(title) {
		var re = new RegExp(title);
		this.filteredTimeslots = this.timeslots.filter(function(ts){
			return ts.event.status == 5 && 
				(title || ts.available_tickets > 0) && 
				ts.event.title.match(re);
		});
	},
	
	addToCart : function(ev) {
		app.cart.add(ev.model.timeslot);
		this.timeslotTitle = ev.model.timeslot.event.title;
		this.$.addedToCart.open();
	},
	
	showEvent : function(ev) {
		page.show('/event/' + ev.model.timeslot.event.id);
	}
});
</script>
